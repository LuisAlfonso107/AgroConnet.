<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Mercado global real. Publica tu oferta o necesidad. Conecta en tiempo real." />
  <meta name="theme-color" content="#00796b" />
  <title>Mercado Global | AgroConnect</title>

  <!-- FUENTES -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet" />

  <!-- CSS EXTERNO -->
  <link rel="stylesheet" href="../styles.css">
   <link rel="stylesheet" href="styles.css">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
</head>
<body>

  <!-- HEADER DINÁMICO -->
  <div id="header-container"></div>
<script>
  fetch("../components/header.html")
    .then(res => res.text())
    .then(html => {
      document.getElementById("header-container").innerHTML = html;
      const script = document.createElement("script");
      script.src = "../components/header.js";
      document.body.appendChild(script);
    });
</script>
 
  <!-- HERO -->
  <section class="mercado-hero">
    <div class="container">
      <h1>Mercado en Vivo</h1>
      <p>Publica tu oferta o necesidad. Conecta con productores y compradores en tiempo real.</p>
      <div class="stats">
        <div class="stat">
          <i class="fas fa-users"></i>
          <strong id="usuariosOnline">1,247</strong>
          <small>Usuarios conectados</small>
        </div>
        <div class="stat">
          <i class="fas fa-exchange-alt"></i>
          <strong id="transaccionesHoy">89</strong>
          <small>Transacciones hoy</small>
        </div>
        <div class="stat">
          <i class="fas fa-globe"></i>
          <strong id="paisesActivos">47</strong>
          <small>Países activos</small>
        </div>
      </div>
    </div>
  </section>

  <!-- PUBLICAR OFERTA / DEMANDA -->
  <section class="container publicar-section">
    <h2>Publica tu Oferta o Necesidad</h2>
    <div class="publicar-tabs">
      <button class="tab-btn active" data-tab="oferta">Vender</button>
      <button class="tab-btn" data-tab="demanda">Comprar</button>
    </div>

    <!-- FORMULARIO OFERTA (VENDEDOR) -->
    <form id="formOferta" class="form-publicar active">
      <div class="form-row">
        <div class="form-group">
          <label>Producto</label>
          <input type="text" placeholder="Ej: Maíz amarillo orgánico" required>
        </div>
        <div class="form-group">
          <label>Cantidad</label>
          <input type="text" placeholder="Ej: 50 toneladas" required>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Precio</label>
          <input type="text" placeholder="Ej: $320/ton" required>
        </div>
        <div class="form-group">
          <label>Certificación</label>
          <input type="text" placeholder="Ej: USDA Orgánico">
        </div>
      </div>
      <div class="form-group">
        <label>Mensaje (opcional)</label>
        <textarea placeholder="Describe tu producto..."></textarea>
      </div>
      <button type="submit" class="btn-publicar">Publicar Oferta</button>
    </form>

    <!-- FORMULARIO DEMANDA (COMPRADOR) -->
    <form id="formDemanda" class="form-publicar">
      <div class="form-row">
        <div class="form-group">
          <label>Necesito</label>
          <input type="text" placeholder="Ej: Maíz amarillo" required>
        </div>
        <div class="form-group">
          <label>Cantidad</label>
          <input type="text" placeholder="Ej: 100 toneladas" required>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Presupuesto</label>
          <input type="text" placeholder="Ej: Hasta $350/ton" required>
        </div>
        <div class="form-group">
          <label>Urgencia</label>
          <select>
            <option>Entrega en 30 días</option>
            <option>Muestras esta semana</option>
            <option>Inmediato</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>Mensaje (opcional)</label>
        <textarea placeholder="Detalles de tu necesidad..."></textarea>
      </div>
      <button type="submit" class="btn-publicar">Publicar Necesidad</button>
    </form>
  </section>

  <!-- ÁREAS DE COMPRA Y VENTA -->
  <section class="container mercado-areas">
    <!-- VENTA -->
    <div class="area-card area-venta">
      <div class="area-header">
        <i class="fas fa-tractor"></i>
        <div>
          <div>Productores Vendiendo</div>
          <small>Ofertas activas</small>
        </div>
      </div>
      <div class="area-body">
        <ul class="actividad-stream" id="ventasStream"></ul>
      </div>
    </div>

    <!-- COMPRA -->
    <div class="area-card area-compra">
      <div class="area-header">
        <i class="fas fa-shopping-cart"></i>
        <div>
          <div>Compradores Buscando</div>
          <small>Necesidades urgentes</small>
        </div>
      </div>
      <div class="area-body">
        <ul class="actividad-stream" id="comprasStream"></ul>
      </div>
    </div>
  </section>

  <!-- MAPA + FILTROS -->
  <section class="container mercado-main">
    <div id="mapa"></div>

    <aside class="filtros">
      <h3>Filtrar Ofertas</h3>
      <div class="filtro-group">
        <label>Producto</label>
        <select id="filtroProducto">
          <option value="">Todos</option>
          <option value="maiz">Maíz</option>
          <option value="cafe">Café</option>
          <option value="aguacate">Aguacate</option>
        </select>
      </div>
      <div class="filtro-group">
        <label>País</label>
        <select id="filtroPais">
          <option value="">Todos</option>
          <option value="MX">México</option>
          <option value="CO">Colombia</option>
          <option value="PE">Perú</option>
        </select>
      </div>
      <div class="filtro-group">
        <label>Precio máx.</label>
        <input type="range" min="0" max="1000" value="1000" id="filtroPrecio">
        <small>Hasta $<span id="precioMax">1,000</span></small>
      </div>
    </aside>
  </section>

  <!-- PRODUCTOS -->
  <section class="container">
    <div class="productos-grid" id="productosGrid"></div>
  </section>

  <!-- NOTIFICACIÓN -->
  <div id="notificacion" class="notificacion" style="display:none;">
    <i class="fas fa-exclamation-triangle"></i>
    <div>
      <strong id="notifTitulo">¡Espera!</strong>
      <small id="notifTexto">Debes crear una cuenta para publicar</small>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="container footer-contenido">
      <p>© 2025 <strong>AgroConnect Global</strong>. Todos los derechos reservados.</p>
      <nav class="footer-nav">
        <a href="#">Contacto</a>
        <a href="#">Privacidad</a>
        <a href="#">Términos</a>
      </nav>
    </div>
  </footer>

  <!-- LEAFLET JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // === SIMULACIÓN DE USUARIO LOGUEADO ===
    let usuarioLogueado = false;
    let rolUsuario = null; // 'vendedor' o 'comprador'

    // CARGAR HEADER
    fetch("../components/header.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("header-container").innerHTML = html;
        const script = document.createElement("script");
        script.src = "../components/header.js";
        document.body.appendChild(script);
      });

    // TABS PUBLICAR
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.form-publicar').forEach(f => f.classList.remove('active'));
        btn.classList.add('active');
        const formId = `form${btn.dataset.tab.charAt(0).toUpperCase() + btn.dataset.tab.slice(1)}`;
        document.getElementById(formId).classList.add('active');
      });
    });

    // CONTROL DE ENVÍO DE FORMULARIOS
    document.querySelectorAll('.form-publicar').forEach(form => {
      form.addEventListener('submit', e => {
        e.preventDefault();

        // Verificar si está logueado
        if (!usuarioLogueado) {
          mostrarNotificacion(
            "¡Espera!",
            "Debes <strong>crear una cuenta</strong> para publicar.",
            "warning"
          );
          setTimeout(() => {
            window.location.href = "../inicioDeSeccion.html";
          }, 2500);
          return;
        }

        // Verificar rol correcto
        const esOferta = form.id === 'formOferta';
        if ((esOferta && rolUsuario !== 'vendedor') || (!esOferta && rolUsuario !== 'comprador')) {
          mostrarNotificacion(
            "Rol incorrecto",
            `Solo los <strong>${esOferta ? 'vendedores' : 'compradores'}</strong> pueden publicar aquí.`,
            "error"
          );
          return;
        }

        // Procesar publicación
        const datos = new FormData(form);
        const entrada = {
          nombre: "Tú",
          ubicacion: "Tu ubicación",
          foto: "https://i.pravatar.cc/150?u=" + Date.now(),
          ...(esOferta ? {
            producto: datos.getAll('input')[0].value,
            cantidad: datos.getAll('input')[1].value,
            precio: datos.getAll('input')[2].value,
            certificado: datos.getAll('input')[3].value || "Sin certificar",
            mensaje: datos.getAll('textarea')[0].value || "Sin mensaje",
            badges: ["nuevo"],
            verificado: false,
            tiempo: "ahora"
          } : {
            necesita: datos.getAll('input')[0].value,
            cantidad: datos.getAll('input')[1].value,
            presupuesto: datos.getAll('input')[2].value,
            urgencia: datos.getAll('select')[0].value,
            mensaje: datos.getAll('textarea')[0].value || "Sin mensaje",
            badges: ["urgente"],
            verificado: false,
            tiempo: "ahora"
          })
        };

        const container = esOferta ? 'ventasStream' : 'comprasStream';
        renderPersona(container, entrada, esOferta);
        form.reset();

        mostrarNotificacion(
          esOferta ? "¡Oferta publicada!" : "¡Necesidad publicada!",
          esOferta ? "Tu producto está en vivo" : "Tu necesidad está visible",
          "success"
        );
      });
    });

    // NOTIFICACIÓN PERSONALIZADA
    function mostrarNotificacion(titulo, texto, tipo = "info") {
      const iconos = { success: "check-circle", warning: "exclamation-triangle", error: "times-circle" };
      const colores = { success: "#8bc34a", warning: "#ffb300", error: "#e53935" };

      document.getElementById('notifTitulo').textContent = titulo;
      document.getElementById('notifTexto').innerHTML = texto;
      const notif = document.getElementById('notificacion');
      notif.style.display = 'flex';
      notif.style.borderLeftColor = colores[tipo];
      notif.querySelector('i').className = `fas fa-${iconos[tipo]}`;
      setTimeout(() => notif.style.display = 'none', 4000);
    }

    // DATOS SIMULADOS
    const vendedores = [
      { nombre: "Juan Pérez", ubicacion: "Chiapas, México", foto: "https://i.pravatar.cc/150?img=1", producto: "Maíz amarillo orgánico", cantidad: "50 toneladas", precio: "$320/ton", certificado: "USDA Orgánico", mensaje: "Cosecha lista para exportación.", badges: ["nuevo"], verificado: true, tiempo: "hace 2 min" },
      { nombre: "María Gómez", ubicacion: "Antioquia, Colombia", foto: "https://i.pravatar.cc/150?img=5", producto: "Café arábica", cantidad: "200 qq", precio: "$850/qq", certificado: "Rainforest", mensaje: "Sabor intenso.", badges: ["premium"], verificado: true, tiempo: "hace 5 min" }
    ];

    const compradores = [
      { nombre: "Distribuidora Europa", ubicacion: "Madrid, España", foto: "https://i.pravatar.cc/150?img=32", necesita: "Maíz amarillo", cantidad: "100 toneladas", presupuesto: "Hasta $350/ton", urgencia: "30 días", mensaje: "Contrato anual.", badges: ["urgente"], verificado: true, tiempo: "hace 1 min" },
      { nombre: "Café & Co.", ubicacion: "Berlín, Alemania", foto: "https://i.pravatar.cc/150?img=28", necesita: "Café especial", cantidad: "50 qq/mes", presupuesto: "Hasta $900/qq", urgencia: "Muestras", mensaje: "3 variedades.", badges: ["muestras"], verificado: true, tiempo: "hace 4 min" }
    ];

    // RENDER PERSONA
    function renderPersona(containerId, p, esVendedor) {
      const container = document.getElementById(containerId);
      const item = document.createElement('li');
      item.className = `actividad-item ${p.badges.includes('urgente') || p.badges.includes('nuevo') ? 'actividad-nueva' : ''}`;

      const badges = p.badges.map(b => {
        const txt = { urgente: 'URGENTE', nuevo: 'NUEVO', organico: 'ORGÁNICO', premium: 'PREMIUM', muestras: 'MUESTRAS' };
        const cls = b === 'urgente' ? 'badge urgente' : b === 'nuevo' ? 'badge nuevo' : 'badge';
        return `<span class="${cls}">${txt[b] || b.toUpperCase()}</span>`;
      }).join('');

      item.innerHTML = `
        <img src="${p.foto}" alt="${p.nombre}" class="usuario-avatar">
        <div class="actividad-content">
          <div class="usuario-nombre">${p.nombre} ${p.verificado ? '<i class="fas fa-check-circle verificado"></i>' : ''}</div>
          <div class="usuario-ubicacion"><i class="fas fa-map-marker-alt"></i> ${p.ubicacion}</div>
          <div class="actividad-texto">
            <strong>${esVendedor ? p.producto : p.necesita}</strong><br>
            ${esVendedor ? `${p.cantidad} · ${p.precio}` : `${p.cantidad} · ${p.presupuesto}`}<br>
            <em>"${p.mensaje}"</em>
          </div>
          <div class="actividad-detalles">
            <div class="actividad-tiempo">${p.tiempo}</div>
            <div class="actividad-badges">${badges}</div>
          </div>
        </div>
        <button class="btn-contactar">${esVendedor ? 'Contactar' : 'Ofertar'}</button>
      `;
      container.prepend(item);
    }

    // INICIALIZAR
    function init() {
      vendedores.forEach(v => renderPersona('ventasStream', v, true));
      compradores.forEach(c => renderPersona('comprasStream', c, false));
    }

    // === MAPA LEAFLET CON ZOOM LIMITADO ===
    const mapa = L.map('mapa', {
      minZoom: 2,
      maxZoom: 10,
      maxBounds: [[-85, -180], [85, 180]],
      maxBoundsViscosity: 1.0
    }).setView([20, 0], 2);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(mapa);

    const marcadores = [
      { lat: 16.75, lng: -93.12, label: "Juan Pérez - Maíz", icon: 'seedling' },
      { lat: 6.25, lng: -75.56, label: "María Gómez - Café", icon: 'coffee' },
      { lat: -13.16, lng: -74.22, label: "Carlos Ruiz - Aguacate", icon: 'apple-alt' }
    ];

    marcadores.forEach(m => {
      const icon = L.divIcon({ className: 'custom-pin', html: `<i class="fas fa-${m.icon}"></i>`, iconSize: [30, 30] });
      L.marker([m.lat, m.lng], { icon }).addTo(mapa)
        .bindPopup(`<b>${m.label}</b>`);
    });

    // ESTADÍSTICAS
    setInterval(() => {
      document.getElementById('usuariosOnline').textContent = (1000 + Math.floor(Math.random() * 800)).toLocaleString();
      document.getElementById('transaccionesHoy').textContent = 50 + Math.floor(Math.random() * 60);
      document.getElementById('paisesActivos').textContent = 35 + Math.floor(Math.random() * 25);
    }, 3000);

    // INICIAR
    init();
  </script>
</body>
</html>